<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - <%= guild.name %></title>
    <style>
        :root{--bg:#050505;--panel:#101012;--text:#fff;--sub:#a1a1aa;--acc:#8b5cf6;--acc-glow:rgba(139,92,246,0.3);--border:#27272a;--input:#18181b;--success:#00ff9d;--danger:#ff0055}
        body{font-family:'Segoe UI',sans-serif;background:var(--bg);margin:0;color:var(--text);display:flex;flex-direction:column;align-items:center;min-height:100vh}
        
        header{background:linear-gradient(180deg, rgba(139,92,246,0.1) 0%, transparent 100%);width:100%;padding:30px 20px;text-align:center;border-bottom:1px solid var(--border);display:flex;justify-content:center;align-items:center;position:relative}
        .back-btn{position:absolute;left:30px;top:50%;transform:translateY(-50%);color:var(--sub);text-decoration:none;font-weight:600;padding:8px 15px;border:1px solid var(--border);border-radius:20px;transition:0.3s;font-size:0.9rem}
        .back-btn:hover{background:var(--acc);color:#000;border-color:var(--acc);box-shadow:0 0 15px rgba(139,92,246,0.4)}
        h1{margin:0;font-size:1.8rem;text-shadow:0 0 10px var(--acc-glow)}
        
        .layout{display:flex;width:90%;max-width:1200px;margin-top:40px;gap:30px;flex-wrap:wrap;padding-bottom:100px}
        .sidebar{flex:1;min-width:250px;display:flex;flex-direction:column;gap:10px}
        .tab-btn{background:var(--panel);border:1px solid var(--border);color:var(--sub);padding:15px 20px;text-align:left;cursor:pointer;border-radius:12px;font-weight:600;transition:0.3s;display:flex;align-items:center;gap:10px}
        .tab-btn:hover{background:#1f1f23;color:var(--text)}
        .tab-btn.active{background:var(--acc);color:#000;border-color:var(--acc);box-shadow:0 0 20px var(--acc-glow)}
        
        .content-area{flex:3;min-width:300px;background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:40px;position:relative}
        .section{display:none;animation:fadeIn 0.3s ease}
        .section.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        
        h2{margin-top:0;border-bottom:1px solid var(--border);padding-bottom:15px;margin-bottom:25px;color:var(--acc)}
        h3{color:var(--text);margin-bottom:10px;border-left:3px solid var(--acc);padding-left:10px}
        .form-group{margin-bottom:25px}
        .label{display:block;margin-bottom:8px;font-weight:600;color:var(--sub);font-size:0.9rem}
        .hint{display:block;margin-top:5px;font-size:0.8rem;color:#52525b}
        
        input, select, textarea{width:100%;padding:12px;background:var(--input);border:1px solid var(--border);color:var(--text);border-radius:8px;font-family:inherit;box-sizing:border-box;transition:0.3s}
        input:focus, select:focus, textarea:focus{outline:none;border-color:var(--acc);box-shadow:0 0 10px rgba(139,92,246,0.2)}
        
        .switch{position:relative;display:inline-block;width:50px;height:26px}
        .switch input{opacity:0;width:0;height:0}
        .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#27272a;transition:.4s;border-radius:34px}
        .slider:before{position:absolute;content:"";height:20px;width:20px;left:3px;bottom:3px;background-color:white;transition:.4s;border-radius:50%}
        input:checked+.slider{background-color:var(--acc);box-shadow:0 0 15px rgba(139,92,246,0.5)}
        input:checked+.slider:before{transform:translateX(24px)}
        
        .item-list{display:flex;flex-direction:column;gap:10px;margin-bottom:20px}
        .item-row{background:#18181b;padding:15px;border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .item-info{display:flex;gap:15px;align-items:center;flex:1;flex-wrap:wrap}
        .tag{background:#27272a;padding:4px 8px;border-radius:4px;font-size:0.85rem;font-family:monospace;border:1px solid var(--border)}
        .role-tag{color:var(--acc);background:rgba(139,92,246,0.1);border-color:rgba(139,92,246,0.3)}
        
        .btn-group { display: flex; gap: 8px; }
        .btn-act { border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-del { background: rgba(255,0,85,0.1); color: var(--danger); border: 1px solid rgba(255,0,85,0.3); } 
        .btn-del:hover { background: var(--danger); color: white; box-shadow: 0 0 10px rgba(255,0,85,0.4); }
        .btn-edit { background: rgba(255,200,0,0.1); color: #ffcc00; border: 1px solid rgba(255,200,0,0.3); } 
        .btn-edit:hover { background: #ffcc00; color: black; box-shadow: 0 0 10px rgba(255,200,0,0.4); }
        
        .btn-action-lg { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 12px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn-action-lg:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5); filter: brightness(1.1); }
        .btn-action-lg.secondary { background: linear-gradient(135deg, #4b5563 0%, #374151 100%); box-shadow: 0 4px 15px rgba(75, 85, 99, 0.3); }
        .btn-action-lg.secondary:hover { box-shadow: 0 6px 20px rgba(75, 85, 99, 0.5); }

        .add-box{background:#18181b;padding:20px;border-radius:12px;border:1px solid var(--border);margin-top:15px}
        .add-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
        .add-row>div{flex:1;min-width:150px}
        .btn-add{background:var(--acc);color:black;border:none;padding:12px 20px;border-radius:8px;font-weight:bold;cursor:pointer;height:42px;width:100%; transition:0.3s;}
        .btn-add:hover { box-shadow: 0 0 15px var(--acc-glow); transform: translateY(-1px); }

        .save-bar{margin-top:30px;padding-top:20px;border-top:1px solid var(--border);text-align:right}
        .btn-save{background:var(--success);color:#000;border:none;padding:12px 30px;border-radius:8px;font-weight:700;cursor:pointer;transition:0.3s;text-transform:uppercase;letter-spacing:1px; box-shadow: 0 0 15px rgba(0,255,157,0.2);}
        .btn-save:hover{box-shadow:0 0 25px rgba(0,255,157,0.5);transform:scale(1.05)}

        .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:100; display:none; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
        .overlay-deploy { z-index: 2000; }
        .overlay-content { background:var(--panel); border:1px solid var(--border); padding:30px; border-radius:20px; width:90%; max-width:700px; max-height:90vh; overflow-y:auto; box-shadow:0 0 50px rgba(0,0,0,0.5); border-top: 4px solid var(--acc); }
        .overlay-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px; }
        .close-btn { background:none; border:none; color:var(--sub); font-size:1.5rem; cursor:pointer; }
        .close-btn:hover { color:white; }
        
        .sub-tabs { display:flex; gap:10px; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:10px; }
        .sub-tab { padding:8px 15px; cursor:pointer; color:var(--sub); font-weight:600; border-radius:8px; transition:0.2s; }
        .sub-tab.active { background:var(--acc); color:black; }
        .sub-section { display:none; }
        .sub-section.active { display:block; }

        .panel-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 10px; }
        .panel-option { background: var(--input); border: 2px solid var(--border); border-radius: 12px; padding: 15px; cursor: pointer; text-align: center; transition: 0.2s; position: relative; user-select: none; }
        .panel-option:hover { transform: translateY(-3px); border-color: var(--sub); }
        .panel-option.selected { border-color: var(--acc); background: rgba(139,92,246,0.1); box-shadow: 0 0 15px rgba(139,92,246,0.2); }
        .panel-option input { display: none; }
        .panel-emoji { font-size: 2rem; display: block; margin-bottom: 5px; }
        .panel-title { font-weight: bold; font-size: 0.9rem; color: var(--text); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .check-icon { position: absolute; top: 5px; right: 5px; color: var(--acc); display: none; font-size: 1.2rem; }
        .panel-option.selected .check-icon { display: block; }

        .toast { position: fixed; bottom: 30px; right: 30px; background: var(--panel); border: 1px solid var(--border); border-left: 5px solid var(--acc); padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 15px; color: var(--text); font-weight: 600; transform: translateX(150%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 5000; }
        .toast.show { transform: translateX(0); }
        .toast-success { border-left-color: #00ff9d; }
        .toast-error { border-left-color: #ff0055; }

        .custom-select-wrapper { position: relative; user-select: none; width: 100%; }
        .custom-select { position: relative; display: flex; flex-direction: column; }
        .custom-select-trigger {
            position: relative; display: flex; align-items: center; justify-content: space-between;
            padding: 12px; font-size: 0.95rem; font-weight: 500; color: var(--text);
            background: var(--input); border: 1px solid var(--border); border-radius: 8px;
            cursor: pointer; transition: 0.3s; min-height: 45px; flex-wrap: wrap; gap: 5px;
        }
        .custom-select-trigger:hover { border-color: var(--sub); }
        .custom-select.open .custom-select-trigger { border-color: var(--acc); box-shadow: 0 0 10px var(--acc-glow); border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .custom-options {
            position: absolute; display: block; top: 100%; left: 0; right: 0;
            background: var(--panel); border: 1px solid var(--acc); border-top: 0;
            border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); z-index: 999;
            opacity: 0; visibility: hidden; pointer-events: none; transform: translateY(-10px);
            transition: 0.3s; max-height: 250px; overflow-y: auto;
        }
        .custom-select.open .custom-options { opacity: 1; visibility: visible; pointer-events: all; transform: translateY(0); }
        .custom-option {
            position: relative; display: flex; align-items: center; padding: 10px 15px;
            font-size: 0.9rem; color: var(--sub); cursor: pointer; transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .custom-option:hover { background: rgba(139,92,246,0.1); color: white; padding-left: 20px; }
        .custom-option.selected { background: var(--acc); color: black; font-weight: bold; }
        .custom-option .color-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; display: inline-block; }

        .select-search {
            width: 100%; padding: 10px; border: none; border-bottom: 1px solid var(--border);
            background: #0f0f11; color: white; font-family: inherit; outline: none;
        }
        .arrow { position: relative; height: 10px; width: 10px; }
        .arrow::after { content: ''; border: solid var(--sub); border-width: 0 2px 2px 0; display: inline-block; padding: 3px; transform: rotate(45deg); transition: 0.3s; }
        .custom-select.open .arrow::after { transform: rotate(-135deg); border-color: var(--acc); }

        .select-badge {
            background: rgba(139,92,246,0.2); color: var(--acc); border: 1px solid rgba(139,92,246,0.3);
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 5px;
        }
        .badge-close { cursor: pointer; font-weight: bold; }
        .badge-close:hover { color: white; }
    </style>
    <script>
        let automodRules = <%- JSON.stringify(automodRules) %>;
        let commandOverrides = <%- JSON.stringify(Object.entries(commandOverrides).map(([k,v])=>({command:k, roles:v}))) %>;
        let customCommands = <%- JSON.stringify(customCommands.map(c => {
            let parsed;
            try { parsed = JSON.parse(c.response_json); } catch { parsed = { content: c.response_json }; }
            return {
                name: c.name, 
                type: parsed.embeds ? 'embed' : 'text',
                content: parsed.content || '',
                embedData: parsed.embeds ? parsed.embeds[0] : { title: '', description: '', color: 5814783, image: {url:''} },
                roles: c.allowed_roles ? c.allowed_roles.split(',') : []
            };
        })) %>;
        let ticketPanels = <%- JSON.stringify(ticketPanels.map(p => ({
            id: p.panel_id, title: p.title, description: p.description, 
            btnLabel: p.button_label, btnEmoji: p.button_emoji, btnStyle: p.button_style,
            supportRole: p.support_role_id, blacklistRole: p.blacklist_role_id,
            category: p.ticket_category_id, logChannel: p.log_channel_id, welcomeMsg: p.welcome_message,
            panelColor: p.panel_color, welcomeColor: p.welcome_color,
            ticketLimit: p.ticket_limit || 1
        }))) %>;
        
        const guildRolesMap = <%- JSON.stringify(guildRoles.reduce((acc,r)=>{acc[r.id]=r.name;return acc},{})) %>;
        const textChannelsMap = <%- JSON.stringify(textChannels.reduce((acc,c)=>{acc[c.id]=c.name;return acc},{})) %>;
        const categoriesMap = <%- JSON.stringify(categories.reduce((acc,c)=>{acc[c.id]=c.name;return acc},{})) %>;
        function isValidEmoji(emoji) {
            const regex = /(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])|<?(a)?:?(\w{2,32}):(\d{17,19})>?|^\d{17,19}$/;
            return regex.test(emoji);
        }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            t.className = `toast toast-${type} show`;
            t.innerHTML = `<span>${type==='success'?'‚úÖ':type==='error'?'‚ùå':'‚ÑπÔ∏è'}</span> ${msg}`;
            setTimeout(()=>t.classList.remove('show'), 3000);
        }

        function togglePanelSelection(checkbox) {
            const label = checkbox.closest('.panel-option');
            if (checkbox.checked) label.classList.add('selected');
            else label.classList.remove('selected');
        }

        function openDeployModal(mode, panelId = null) {
            const title = document.getElementById('deploy-title');
            const content = document.getElementById('deploy-content');
            const btn = document.getElementById('deploy-btn');
            
            let html = `
                <div class="form-group">
                    <label class="label">üì¢ Destination Channel</label>
                    <select id="deploy-channel">
                        <option value="">Select Channel...</option>
                        <% textChannels.forEach(c => { %>
                            <option value="<%= c.id %>">#<%= c.name %></option>
                        <% }) %>
                    </select>
                </div>
            `;
            if (mode === 'single') {
                title.innerText = "Post Single Panel";
                btn.innerText = "Post Now";
                content.innerHTML = html;
                
                btn.onclick = () => {
                    const chId = document.getElementById('deploy-channel').value;
                    if (!chId) return showToast("Select a channel", 'error');
                    fetch('/api/tickets/post-panel', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({guildId:'<%= guild.id %>', panelId: panelId, channelId: chId})
                    }).then(res => res.json()).then(data => {
                        if(data.success) { showToast("Panel Posted!", 'success'); document.getElementById('overlay-deploy').style.display = 'none'; }
                        else showToast("Error: " + data.error, 'error');
                    });
                };
            } else if (mode === 'multi') {
                title.innerText = "Create Multipanel";
                btn.innerText = "Create Multipanel";
                
                let gridHtml = '<div class="form-group"><label class="label">üß© Select Panels to Merge</label><div class="panel-grid">';
                ticketPanels.forEach(p => {
                    gridHtml += `
                    <label class="panel-option">
                        <input type="checkbox" class="panel-chk" value="${p.id}" onchange="togglePanelSelection(this)">
                        <div class="check-icon">‚úî</div>
                        <span class="panel-emoji">${p.btnEmoji || 'üé´'}</span>
                        <span class="panel-title">${p.title}</span>
                    </label>`;
                });
                gridHtml += '</div></div>';
                
                content.innerHTML = gridHtml + html;

                btn.onclick = () => {
                    const chId = document.getElementById('deploy-channel').value;
                    const selected = Array.from(document.querySelectorAll('.panel-chk:checked')).map(cb => cb.value);
                    
                    if (!chId) return showToast("Select a channel", 'error');
                    if (selected.length < 2) return showToast("Select at least 2 panels", 'error');
                    fetch('/api/tickets/post-multipanel', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({guildId:'<%= guild.id %>', panels: selected, channelId: chId})
                    }).then(res => res.json()).then(data => {
                        if(data.success) { showToast("Multipanel Posted!", 'success'); document.getElementById('overlay-deploy').style.display = 'none'; }
                        else showToast("Error: " + data.error, 'error');
                    });
                };
            }

            document.getElementById('overlay-deploy').style.display = 'flex';
        }

        function updateDurationField() {
            const action = document.getElementById('am_action').value;
            const durationDiv = document.getElementById('div_duration');
            if(action==='Kick'){ durationDiv.style.display='none'; }
            else { durationDiv.style.display='block'; }
        }
        function renderAutomod() {
            document.getElementById('automod-list').innerHTML = automodRules.map((r,i) => `
                <div class="item-row">
                    <div class="item-info">
                        <span style="font-weight:bold;color:#facc15">${r.warnings} Warns</span><span>‚ûî</span>
                        <span class="tag">${r.action}</span>${r.duration?`<span class="tag">${r.duration}</span>`:''}
                    </div>
                    <button class="btn-act btn-del" onclick="automodRules.splice(${i},1);renderAutomod()">üóëÔ∏è</button>
                </div>`).join('');
        }
        function addAutomod() {
            const w = parseInt(document.getElementById('am_warns').value), a = document.getElementById('am_action').value, d = document.getElementById('am_duration').value;
            if(isNaN(w)||w<1||w>10) return showToast("Warnings must be 1-10", 'error');
            if(a==='Timeout'&&!d) return showToast("Timeout requires duration", 'error');
            automodRules.push({warnings:w, action:a, duration:d}); automodRules.sort((a,b)=>a.warnings-b.warnings);
            renderAutomod(); document.getElementById('am_warns').value=''; document.getElementById('am_duration').value='';
        }

        function renderPerms() {
            document.getElementById('perms-list').innerHTML = commandOverrides.map((o,i) => `
                <div class="item-row">
                    <div class="item-info"><span style="color:#8b5cf6;font-weight:bold">/${o.command}</span><span style="color:#555">Allowed:</span>
                        ${o.roles.map(r=>`<span class="tag role-tag">@${guildRolesMap[r]||r}</span>`).join('')}
                    </div>
                    <button class="btn-act btn-del" onclick="commandOverrides.splice(${i},1);renderPerms()">üóëÔ∏è</button>
                </div>`).join('');
        }
        function addPerm() {
            const c = document.getElementById('perm_cmd').value, rs = Array.from(document.getElementById('perm_roles').selectedOptions).map(o=>o.value);
            if(rs.length===0) return showToast("Select at least one role", 'error');
            commandOverrides = commandOverrides.filter(o=>o.command!==c); commandOverrides.push({command:c, roles:rs}); renderPerms();
            document.getElementById('perm_roles').value = "";
        }

        let currentCCIndex = -1;
        function renderCC() {
            document.getElementById('cc-list').innerHTML = customCommands.map((c,i) => `
                <div class="item-row">
                    <div class="item-info"><span style="color:#8b5cf6;font-weight:bold">!${c.name}</span>
                        <span class="tag">${c.type.toUpperCase()}</span>
                        ${c.roles.length ? c.roles.map(r=>`<span class="tag role-tag">@${guildRolesMap[r]||r}</span>`).join('') : '<span class="tag">All</span>'}
                    </div>
                    <div class="btn-group">
                        <button class="btn-act btn-edit" onclick="openCCEditor(${i})">‚úèÔ∏è</button>
                        <button class="btn-act btn-del" onclick="customCommands.splice(${i},1);renderCC()">üóëÔ∏è</button>
                    </div>
                </div>`).join('');
        }
        function toggleCCMode() {
            const mode = document.getElementById('cc_mode').value;
            document.getElementById('cc_section_text').style.display = mode === 'text' ? 'block' : 'none';
            document.getElementById('cc_section_embed').style.display = mode === 'embed' ? 'block' : 'none';
        }
        function openCCEditor(i) {
            currentCCIndex = i;
            const c = i === -1 ? {name:'', type:'text', content:'', embedData:{title:'', description:'', color:'#5865F2', image:{url:''}}, roles:[]} : customCommands[i];
            document.getElementById('edit_cc_name').value = c.name;
            document.getElementById('cc_mode').value = c.type;
            document.getElementById('cc_content').value = c.content;
            document.getElementById('cc_emb_title').value = c.embedData?.title || '';
            document.getElementById('cc_emb_desc').value = c.embedData?.description || '';
            document.getElementById('cc_emb_color').value = c.embedData?.color ? '#' + parseInt(c.embedData.color).toString(16) : '#5865F2';
            document.getElementById('cc_emb_img').value = c.embedData?.image?.url || '';
            const rolesSel = document.getElementById('edit_cc_roles');
            Array.from(rolesSel.options).forEach(o => o.selected = c.roles.includes(o.value));
            toggleCCMode();
            switchSubTab('btn-cc_msg'); 
            document.getElementById('overlay-cc').style.display = 'flex';
        }
        function saveCC() {
            const name = document.getElementById('edit_cc_name').value.trim();
            const type = document.getElementById('cc_mode').value;
            const roles = Array.from(document.getElementById('edit_cc_roles').selectedOptions).map(o=>o.value);
            if(!name) return showToast("Command Name required", 'error');
            const newCmd = {
                name, type, roles,
                content: document.getElementById('cc_content').value,
                embedData: {
                    title: document.getElementById('cc_emb_title').value,
                    description: document.getElementById('cc_emb_desc').value,
                    color: parseInt(document.getElementById('cc_emb_color').value.replace('#',''), 16),
                    image: { url: document.getElementById('cc_emb_img').value }
                }
            };
            if(currentCCIndex === -1) customCommands.push(newCmd);
            else customCommands[currentCCIndex] = newCmd;
            renderCC(); document.getElementById('overlay-cc').style.display = 'none';
        }

        let currentTicketIndex = -1;
        function renderTickets() {
            document.getElementById('tickets-list').innerHTML = ticketPanels.map((p,i) => `
                <div class="item-row">
                    <div class="item-info">
                        <span style="font-weight:bold">${p.title}</span><span class="tag">${p.id}</span>
                        <span class="tag">#${categoriesMap[p.category] || 'Unknown'}</span>
                    </div>
                    <div class="btn-group">
                        <button class="btn-act btn-edit" onclick="openTicketEditor(${i})">‚úèÔ∏è</button>
                        <button class="btn-act btn-del" onclick="ticketPanels.splice(${i},1);renderTickets()">üóëÔ∏è</button>
                    </div>
                </div>`).join('');
        }
        function openTicketEditor(i) {
            currentTicketIndex = i;
            const p = i === -1 ? {id:'', title:'Support', description:'Open ticket', category:'', supportRole:'', blacklistRole:'', logChannel:'', btnLabel:'Open', btnEmoji:'üì©', btnStyle:'Primary', welcomeMsg:'Hello {user}', panelColor:'#5865F2', welcomeColor:'#5865F2', ticketLimit: 1} : ticketPanels[i];
            document.getElementById('tk_id').value = p.id;
            document.getElementById('tk_title').value = p.title;
            document.getElementById('tk_desc').value = p.description;
            document.getElementById('tk_cat').value = p.category;
            document.getElementById('tk_role_supp').value = p.supportRole;
            document.getElementById('tk_role_black').value = p.blacklistRole;
            document.getElementById('tk_log').value = p.logChannel;
            document.getElementById('tk_btn_lbl').value = p.btnLabel;
            document.getElementById('tk_btn_emoji').value = p.btnEmoji;
            document.getElementById('tk_btn_style').value = p.btnStyle;
            document.getElementById('tk_welcome').value = p.welcomeMsg;
            document.getElementById('tk_col_panel').value = p.panelColor;
            document.getElementById('tk_col_welcome').value = p.welcomeColor;
            document.getElementById('tk_limit').value = p.ticketLimit;
            document.getElementById('tk_id').disabled = (i !== -1);
            switchSubTab('btn-tk_app');
            document.getElementById('overlay-ticket').style.display = 'flex';
        }
        function saveTicket() {
            const id = document.getElementById('tk_id').value.trim();
            const emoji = document.getElementById('tk_btn_emoji').value.trim();
            const limit = parseInt(document.getElementById('tk_limit').value);
            if(!id) return showToast("Panel ID Required", 'error');
            if(emoji && !isValidEmoji(emoji)) return showToast("Invalid Emoji", 'error');
            if(limit < 1) return showToast("Limit must be at least 1", 'error');
            const panel = {
                id: id,
                title: document.getElementById('tk_title').value,
                description: document.getElementById('tk_desc').value,
                category: document.getElementById('tk_cat').value,
                supportRole: document.getElementById('tk_role_supp').value,
                blacklistRole: document.getElementById('tk_role_black').value,
                logChannel: document.getElementById('tk_log').value,
                btnLabel: document.getElementById('tk_btn_lbl').value,
                btnEmoji: emoji,
                btnStyle: document.getElementById('tk_btn_style').value,
                welcomeMsg: document.getElementById('tk_welcome').value,
                panelColor: document.getElementById('tk_col_panel').value,
                welcomeColor: document.getElementById('tk_col_welcome').value,
                ticketLimit: limit
            };
            if(currentTicketIndex === -1) ticketPanels.push(panel);
            else ticketPanels[currentTicketIndex] = panel;
            renderTickets(); document.getElementById('overlay-ticket').style.display = 'none';
        }
        function postTicketPanel() {
            if(currentTicketIndex === -1) return showToast("Save panel first", 'error');
            openDeployModal('single', ticketPanels[currentTicketIndex].id);
        }
        function createMultipanel() {
            if(ticketPanels.length < 2) return showToast("Need at least 2 panels", 'error');
            openDeployModal('multi');
        }

        function switchSubTab(id) {
            const parent = document.getElementById(id).closest('.overlay-content');
            parent.querySelectorAll('.sub-tab').forEach(e=>e.classList.remove('active'));
            parent.querySelectorAll('.sub-section').forEach(e=>e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const sectionId = id.replace('btn-', '');
            document.getElementById(sectionId).classList.add('active');
        }
        function openTab(name) {
            document.querySelectorAll('.section,.tab-btn').forEach(e=>e.classList.remove('active'));
            document.getElementById(name).classList.add('active'); document.getElementById('btn-'+name).classList.add('active');
        }
        async function saveConfig() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "SAVING..."; btn.style.opacity = "0.7";
            const finalCC = customCommands.map(c => ({
                name: c.name,
                roles: c.roles,
                response: JSON.stringify(c.type === 'embed' ? { embeds: [c.embedData] } : { content: c.content })
            }));
            const data = {
                prefix: document.getElementById('prefix').value,
                staff_roles: document.getElementById('staff_roles').value,
                log_mod: document.getElementById('log_mod').value,
                log_cmd: document.getElementById('log_cmd').value,
                log_appeal: document.getElementById('log_appeal').value,
                log_nuke: document.getElementById('log_nuke').value,
                antinuke_enabled: document.getElementById('antinuke').checked ? 'on':'off',
                lockdown_channels: Array.from(document.getElementById('lockdown_channels').selectedOptions).map(o=>o.value),
                automod_rules: automodRules, command_overrides: commandOverrides,
                custom_commands: finalCC, ticket_panels: ticketPanels
            };
            try {
                const res = await fetch('/api/setup/<%= guild.id %>', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(data)});
                if(res.ok) { 
                    btn.innerText = "SAVED!";
                    btn.style.background = "#00ff9d"; 
                    showToast("Configuration saved successfully", 'success');
                    setTimeout(() => { btn.innerText = "SAVE CHANGES"; btn.style.background = "#00ff9d"; }, 2000);
                }
                else { 
                    const err = await res.json();
                    btn.innerText = "ERROR"; btn.style.background = "#ff0055"; 
                    showToast(err.error || "Failed to save configuration", 'error');
                }
            } catch(e){ showToast("Connection error", 'error'); }
            btn.style.opacity = "1";
        }

        function enhanceAllSelects() {
            document.querySelectorAll('select').forEach(el => {
                if (el.classList.contains('enhanced') || el.id === 'deploy-channel') return;
                
                el.style.display = 'none'; 
                el.classList.add('enhanced');

                const wrapper = document.createElement('div');
                wrapper.className = 'custom-select-wrapper';
                el.parentNode.insertBefore(wrapper, el);
                wrapper.appendChild(el);

                const customSelect = document.createElement('div');
                customSelect.className = 'custom-select';
                
                const trigger = document.createElement('div');
                trigger.className = 'custom-select-trigger';
                trigger.innerHTML = `<div class="selection-text">Select...</div><div class="arrow"></div>`;
                customSelect.appendChild(trigger);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'custom-options';
                
                const searchInput = document.createElement('input');
                searchInput.className = 'select-search';
                searchInput.placeholder = 'üîç Search...';
                searchInput.onclick = (e) => e.stopPropagation(); 
                searchInput.onkeyup = function() {
                    const filter = this.value.toLowerCase();
                    const opts = optionsDiv.querySelectorAll('.custom-option');
                    opts.forEach(opt => {
                        const txt = opt.textContent || opt.innerText;
                        opt.style.display = txt.toLowerCase().indexOf(filter) > -1 ? 'flex' : 'none';
                    });
                };
                optionsDiv.appendChild(searchInput);

                function populateOptions() {
                    while(optionsDiv.children.length > 1) optionsDiv.removeChild(optionsDiv.lastChild);
                    
                    Array.from(el.options).forEach(opt => {
                        if(opt.value === "") return; 
                        const div = document.createElement('div');
                        div.className = 'custom-option';
                        div.dataset.value = opt.value;
                        
                        const color = opt.style.color || null;
                        div.innerHTML = `${color ? `<span class="color-dot" style="background:${color}"></span>` : ''}${opt.text}`;
                        
                        if (opt.selected) div.classList.add('selected');

                        div.addEventListener('click', function(e) {
                            e.stopPropagation(); 
                            if (el.multiple) {
                                opt.selected = !opt.selected;
                                this.classList.toggle('selected');
                                updateTrigger();
                            } else {
                                el.value = this.dataset.value;
                                el.dispatchEvent(new Event('change')); 
                                
                                optionsDiv.querySelectorAll('.custom-option').forEach(c => c.classList.remove('selected'));
                                this.classList.add('selected');
                                updateTrigger();
                                customSelect.classList.remove('open');
                            }
                        });
                        optionsDiv.appendChild(div);
                    });
                }
                populateOptions();
                customSelect.appendChild(optionsDiv);
                wrapper.appendChild(customSelect);

                function updateTrigger() {
                    const selected = Array.from(el.selectedOptions);
                    const textDiv = trigger.querySelector('.selection-text');
                    if (selected.length === 0) {
                        textDiv.innerHTML = '<span style="color:var(--sub)">Select option...</span>';
                    } else if (el.multiple) {
                        textDiv.innerHTML = selected.map(s => 
                            `<span class="select-badge">${s.text}<span class="badge-close" onclick="deselect('${el.id}', '${s.value}', event)">√ó</span></span>`
                        ).join('');
                    } else {
                        const s = selected[0];
                        const color = s.style.color;
                        textDiv.innerHTML = `${color ? `<span class="color-dot" style="background:${color}"></span>` : ''}${s.text}`;
                    }
                }
                
                window.deselect = function(selectId, val, e) {
                    e.stopPropagation();
                    const select = document.getElementById(selectId);
                    const opt = Array.from(select.options).find(o => o.value === val);
                    if(opt) opt.selected = false;
                    const parent = select.closest('.custom-select-wrapper');
                    parent.querySelector(`.custom-option[data-value="${val}"]`).classList.remove('selected');
                    const event = new Event('change');
                    select.dispatchEvent(event);
                    const textContainer = parent.querySelector('.selection-text');
                    const newSelected = Array.from(select.selectedOptions);
                    if (newSelected.length === 0) {
                        textContainer.innerHTML = '<span style="color:var(--sub)">Select option...</span>';
                    } else {
                        textContainer.innerHTML = newSelected.map(s => 
                            `<span class="select-badge">${s.text}<span class="badge-close" onclick="deselect('${selectId}', '${s.value}', event)">√ó</span></span>`
                        ).join('');
                    }
                };

                updateTrigger();

                trigger.addEventListener('click', function() {
                    document.querySelectorAll('.custom-select').forEach(s => {
                        if(s !== customSelect) s.classList.remove('open');
                    });
                    customSelect.classList.toggle('open');
                    if(customSelect.classList.contains('open')) searchInput.focus();
                });
                
                el.addEventListener('change', updateTrigger);
            });

            window.addEventListener('click', function(e) {
                if (!e.target.closest('.custom-select-wrapper')) {
                    document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
                }
            });
        }

        window.onload = () => { renderAutomod(); renderPerms(); renderCC(); renderTickets(); updateDurationField(); enhanceAllSelects(); };
    </script>
</head>
<body>
    <header><a href="/manage/<%= guild.id %>" class="back-btn">‚Üê Dashboard</a><h1>System Configuration</h1></header>
    
    <div id="toast" class="toast"></div>

    <div id="overlay-deploy" class="overlay overlay-deploy">
        <div class="overlay-content" style="max-width:500px">
            <div class="overlay-header"><h2 id="deploy-title">Deploy</h2><button class="close-btn" onclick="document.getElementById('overlay-deploy').style.display='none'">‚úñ</button></div>
            <div id="deploy-content"></div>
            <button id="deploy-btn" class="btn-action-lg" style="width:100%;margin-top:20px;justify-content:center;">Deploy</button>
        </div>
    </div>

    <div class="layout">
        <div class="sidebar">
            <div id="btn-channels" class="tab-btn active" onclick="openTab('channels')"><span>üì∫</span> Channels</div>
            <div id="btn-automod" class="tab-btn" onclick="openTab('automod')"><span>ü§ñ</span> Automod</div>
            <div id="btn-roles" class="tab-btn" onclick="openTab('roles')"><span>üîê</span> Permissions</div>
            <div id="btn-custom" class="tab-btn" onclick="openTab('custom')"><span>‚ö°</span> Custom Cmds</div>
            <div id="btn-tickets" class="tab-btn" onclick="openTab('tickets')"><span>üé´</span> Tickets</div>
            <div id="btn-protection" class="tab-btn" onclick="openTab('protection')"><span>üõ°Ô∏è</span> Protection</div>
            <div id="btn-general" class="tab-btn" onclick="openTab('general')"><span>‚å®Ô∏è</span> General</div>
        </div>
        
        <div class="content-area">
            <div id="channels" class="section active">
                <h2>Log Channels</h2>
                <div class="form-group"><label class="label">Mod Logs</label><select id="log_mod"><option value="">None</option><% textChannels.forEach(c=>{ %><option value="<%= c.id %>" <%= logs.modlog==c.id?'selected':'' %>>#<%= c.name %></option><% }) %></select></div>
                <div class="form-group"><label class="label">Command Logs</label><select id="log_cmd"><option value="">None</option><% textChannels.forEach(c=>{ %><option value="<%= c.id %>" <%= logs.cmdlog==c.id?'selected':'' %>>#<%= c.name %></option><% }) %></select></div>
                <div class="form-group"><label class="label">Appeal Logs</label><select id="log_appeal"><option value="">None</option><% textChannels.forEach(c=>{ %><option value="<%= c.id %>" <%= logs.banappeal==c.id?'selected':'' %>>#<%= c.name %></option><% }) %></select></div>
                <div class="form-group"><label class="label">Anti-Nuke Logs</label><select id="log_nuke"><option value="">None</option><% textChannels.forEach(c=>{ %><option value="<%= c.id %>" <%= logs.antinuke==c.id?'selected':'' %>>#<%= c.name %></option><% }) %></select></div>
            </div>

            <div id="automod" class="section">
                <h2>Automod Rules</h2>
                <div id="automod-list" class="item-list"></div>
                <div class="add-box"><h3>Add Rule</h3><div class="add-row">
                    <div><label class="label">Warns (1-10)</label><input type="number" id="am_warns" min="1" max="10"></div>
                    <div><label class="label">Action</label><select id="am_action" onchange="updateDurationField()"><option>Timeout</option><option>Kick</option><option>Ban</option></select></div>
                    <div id="div_duration"><label class="label">Duration</label><input type="text" id="am_duration" placeholder="e.g. 10m"></div>
                    <button class="btn-add" onclick="addAutomod()">+</button>
                </div></div>
            </div>

            <div id="roles" class="section">
                <h2>Permissions</h2>
                <div class="form-group"><label class="label">Staff Role</label><select id="staff_roles"><option value="">None</option><% guildRoles.forEach(r=>{ %><option value="<%= r.id %>" style="color:<%= r.color %>" <%= settings.staff_roles==r.id?'selected':'' %>>@<%= r.name %></option><% }) %></select></div>
                <hr style="border:0;border-top:1px solid var(--border);margin:30px 0">
                <h3>Command Overrides</h3>
                <div id="perms-list" class="item-list"></div>
                <div class="add-box"><h3>Add Override</h3><div class="add-row">
                    <div style="flex:1"><label class="label">Command</label><select id="perm_cmd"><% botCommands.forEach(c=>{ %><option value="<%= c %>">/<%= c %></option><% }) %></select></div>
                    <div style="flex:2"><label class="label">Allowed Roles</label><select id="perm_roles" multiple style="height:100px"><% guildRoles.forEach(r=>{ %><option value="<%= r.id %>" style="color:<%= r.color %>"><%= r.name %></option><% }) %></select></div>
                    <button class="btn-add" onclick="addPerm()">Add</button>
                </div></div>
            </div>

            <div id="custom" class="section">
                <h2>Custom Commands</h2>
                <div id="cc-list" class="item-list"></div>
                <button class="btn-add" onclick="openCCEditor(-1)">+ New Command</button>
            </div>

            <div id="tickets" class="section">
                <h2>Ticket Panels</h2>
                <div id="tickets-list" class="item-list"></div>
                <div class="add-row" style="margin-top:20px; gap:15px">
                    <button class="btn-add" onclick="openTicketEditor(-1)">+ Create Panel</button>
                    <button class="btn-action-lg secondary" style="flex:1; justify-content:center" onclick="createMultipanel()">Create Multipanel</button>
                </div>
            </div>

            <div id="protection" class="section">
                <h2>Protection</h2>
                <div class="form-group"><label class="label">Anti-Nuke</label><label class="switch"><input type="checkbox" id="antinuke" <%= antinuke?'checked':'' %>><span class="slider"></span></label></div>
                <div class="form-group"><label class="label">Lockdown Channels</label><select id="lockdown_channels" multiple style="height:150px"><% textChannels.forEach(c=>{ %><option value="<%= c.id %>" <%= lockdownChannels.includes(c.id)?'selected':'' %>>#<%= c.name %></option><% }) %></select></div>
            </div>

            <div id="general" class="section">
                <h2>General</h2>
                <div class="form-group"><label class="label">Prefix</label><input type="text" id="prefix" value="<%= settings.prefix||'!' %>"></div>
            </div>

            <div class="save-bar"><button id="saveBtn" class="btn-save" onclick="saveConfig()">Save Changes</button></div>
        </div>
    </div>

    <div id="overlay-cc" class="overlay"><div class="overlay-content">
        <div class="overlay-header"><h2>Edit Command</h2><button class="close-btn" onclick="document.getElementById('overlay-cc').style.display='none'">‚úñ</button></div>
        <div class="sub-tabs"><div id="btn-cc_msg" class="sub-tab active" onclick="switchSubTab('btn-cc_msg')">Message</div><div id="btn-cc_perm" class="sub-tab" onclick="switchSubTab('btn-cc_perm')">Permissions</div></div>
        <div id="cc_msg" class="sub-section active">
            <div class="form-group"><label class="label">Name</label><input type="text" id="edit_cc_name" placeholder="rules"></div>
            <div class="form-group"><label class="label">Type</label><select id="cc_mode" onchange="toggleCCMode()"><option value="text">Simple Text</option><option value="embed">Advanced Embed</option></select></div>
            <div id="cc_section_text"><div class="form-group"><label class="label">Content</label><textarea id="cc_content" rows="4"></textarea></div></div>
            <div id="cc_section_embed" style="display:none">
                <div class="form-group"><label class="label">Title</label><input type="text" id="cc_emb_title"></div>
                <div class="form-group"><label class="label">Description</label><textarea id="cc_emb_desc" rows="3"></textarea></div>
                <div class="add-row"><div><label class="label">Color (Hex)</label><input type="text" id="cc_emb_color" placeholder="#5865F2"></div><div><label class="label">Image URL</label><input type="text" id="cc_emb_img"></div></div>
            </div>
        </div>
        <div id="cc_perm" class="sub-section"><div class="form-group"><label class="label">Allowed Roles</label><select id="edit_cc_roles" multiple style="height:150px"><% guildRoles.forEach(r=>{ %><option value="<%= r.id %>" style="color:<%= r.color %>"><%= r.name %></option><% }) %></select></div></div>
        <button class="btn-save" style="width:100%;margin-top:20px" onclick="saveCC()">Save Command</button>
    </div></div>

    <div id="overlay-ticket" class="overlay"><div class="overlay-content">
        <div class="overlay-header"><h2>Edit Ticket Panel</h2><button class="close-btn" onclick="document.getElementById('overlay-ticket').style.display='none'">‚úñ</button></div>
        <div class="sub-tabs">
            <div id="btn-tk_app" class="sub-tab active" onclick="switchSubTab('btn-tk_app')">Appearance</div>
            <div id="btn-tk_roles" class="sub-tab" onclick="switchSubTab('btn-tk_roles')">Roles</div>
            <div id="btn-tk_gen" class="sub-tab" onclick="switchSubTab('btn-tk_gen')">General</div>
        </div>
        
        <div id="tk_app" class="sub-section active">
            <div class="form-group"><label class="label">Panel ID</label><input type="text" id="tk_id"></div>
            <div class="form-group"><label class="label">Title</label><input type="text" id="tk_title"></div>
            <div class="form-group"><label class="label">Description</label><textarea id="tk_desc" rows="3"></textarea></div>
            <div class="add-row">
                <div><label class="label">Btn Label</label><input type="text" id="tk_btn_lbl"></div>
                <div><label class="label">Emoji</label><input type="text" id="tk_btn_emoji"></div>
                <div><label class="label">Style</label><select id="tk_btn_style"><option value="Primary">Blue</option><option value="Secondary">Grey</option><option value="Success">Green</option><option value="Danger">Red</option></select></div>
            </div>
            <div class="add-row" style="margin-top:15px">
                <div><label class="label">Panel Color</label><input type="text" id="tk_col_panel"></div>
                <div><label class="label">Welcome Color</label><input type="text" id="tk_col_welcome"></div>
            </div>
            <div class="form-group" style="margin-top:15px"><label class="label">Welcome Message</label><textarea id="tk_welcome" rows="2"></textarea></div>
        </div>

        <div id="tk_roles" class="sub-section">
            <div class="form-group"><label class="label">Support Role</label><select id="tk_role_supp"><option value="">None</option><% guildRoles.forEach(r=>{ %><option value="<%= r.id %>"><%= r.name %></option><% }) %></select></div>
            <div class="form-group"><label class="label">Blacklist Role</label><select id="tk_role_black"><option value="">None</option><% guildRoles.forEach(r=>{ %><option value="<%= r.id %>"><%= r.name %></option><% }) %></select></div>
        </div>

        <div id="tk_gen" class="sub-section">
            <div class="form-group"><label class="label">Ticket Category</label><select id="tk_cat"><% categories.forEach(c=>{ %><option value="<%= c.id %>"><%= c.name %></option><% }) %></select></div>
            <div class="form-group"><label class="label">Log Channel</label><select id="tk_log"><option value="">None</option><% textChannels.forEach(c=>{ %><option value="<%= c.id %>">#<%= c.name %></option><% }) %></select></div>
            <div class="form-group"><label class="label">Ticket Limit per User</label><input type="number" id="tk_limit" min="1"></div>
            <button class="btn-action-lg" style="width:100%;margin-top:20px;justify-content:center" onclick="postTicketPanel()">üì® Post Panel to Channel</button>
        </div>

        <button class="btn-save" style="width:100%;margin-top:20px" onclick="saveTicket()">Update Panel in List</button>
        <p class="hint" style="text-align:center; margin-top:10px">Changes are local until you click "Save Changes".</p>
    </div></div>
</body>
</html>